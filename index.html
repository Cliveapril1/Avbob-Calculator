<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AVBOB Premium Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <div id="app" class="max-w-2xl mx-auto p-4 pt-16">
    <header class="flex items-center gap-3 mb-6 bg-white p-4 rounded-2xl shadow-md">
      <div class="w-14 h-14 rounded-lg bg-green-700 flex items-center justify-center text-white text-2xl font-bold">A</div>
      <div>
        <h1 class="text-xl font-bold text-gray-800">Clive's Premium Calculator</h1>
        <p class="text-sm text-slate-600">Contact Clive to help calculate your funeral/Cash cover premium instantly 0678441434</p>
      </div>
    </header>

    <main class="space-y-4">
      <!-- Product Selection -->
      <section class="bg-white p-5 rounded-2xl shadow-md">
        <h2 class="font-semibold text-lg mb-3">Select the kind of policy Product(whatsapp me if you want help)</h2>
        <select id="productType" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:border-green-600" onchange="updateProductFields()">
          <option value="">Choose a product with or without Cashback ...</option>
          <option value="cashback">Cashback Funeral Cover</option>
          <option value="repatriation">Cash Policy (Repatriation)</option>
          <option value="pensioner">Pensioner Funeral Plan (Older Than 64)</option>
        </select>
      </section>

      <!-- Main Member -->
      <section id="mainSection" class="bg-white p-5 rounded-2xl shadow-md hidden">
        <h2 class="font-semibold text-lg mb-3">Main Member Details</h2>
        <input id="mainName" class="w-full p-3 rounded-lg border mb-3" placeholder="Full name" />
        <input id="mainDOB" type="date" class="w-full p-3 rounded-lg border mb-3" onchange="calculateQuote()" />

        <div id="payerTypeDiv" class="mb-3">
          <label class="block text-sm font-medium mb-2">Who will pay premiums?</label>
          <select id="payerType" class="w-full p-3 rounded-lg border" onchange="calculateQuote()">
            <option value="self">Self (J18/R11)</option>
            <option value="third">Third Party (J19/R12)</option>
          </select>
        </div>

        <div id="coverDiv">
          <label class="block text-sm font-medium mb-2">Cover Amount</label>
          
          <!-- Cashback: Slider 10k–50k -->
          <div id="cashbackCoverControls">
            <input type="range" id="mainCover" min="10000" max="50000" step="5000" value="20000" class="w-full" oninput="updateCoverLabel();calculateQuote()" />
            <p class="text-center font-semibold text-green-700" id="mainCoverLabel">R20,000</p>
          </div>

          <!-- Repatriation: 3 buttons only -->
          <div id="repatriationCoverControls" class="hidden space-y-3">
            <button type="button" onclick="setRepatriationCover(10000)" class="w-full p-4 rounded-lg border-2 border-gray-300 hover:border-green-600 transition ${document.getElementById('mainCoverHidden')?.value == 10000 ? 'bg-green-600 text-white border-green-600' : 'bg-white'}">
              R10,000 Cover
            </button>
            <button type="button" onclick="setRepatriationCover(20000)" class="w-full p-4 rounded-lg border-2 border-gray-300 hover:border-green-600 transition ${document.getElementById('mainCoverHidden')?.value == 20000 ? 'bg-green-600 text-white border-green-600' : 'bg-white'}">
              R20,000 Cover
            </button>
            <button type="button" onclick="setRepatriationCover(30000)" class="w-full p-4 rounded-lg border-2 border-gray-300 hover:border-green-600 transition ${document.getElementById('mainCoverHidden')?.value == 30000 ? 'bg-green-600 text-white border-green-600' : 'bg-white'}">
              R30,000 Cover
            </button>
            <input type="hidden" id="mainCoverHidden" value="20000">
            <p class="text-center font-semibold text-green-700" id="mainCoverLabelRepat">R20,000</p>
          </div>
        </div>

        <div id="pensionerOptions" class="hidden mt-3">
          <label class="block text-sm font-medium mb-2">Premium Type</label>
          <select id="pensionerPremType" class="w-full p-3 rounded-lg border" onchange="calculateQuote()">
            <option value="monthly">Monthly Premium</option>
            <option value="single">Single Premium (R10,000)</option>
          </select>
        </div>
      </section>

      <!-- Additional Members -->
      <section id="additionalSection" class="bg-white p-5 rounded-2xl shadow-md hidden">
        <h2 class="font-semibold text-lg mb-3">Additional Members (Optional)</h2>

        <div class="mb-4">
          <h3 class="font-medium mb-2">Spouse</h3>
          <div id="spouseList" class="space-y-2 mb-2"></div>
          <button onclick="addMember('spouse')" class="bg-green-100 text-green-700 px-4 py-2 rounded-lg w-full hover:bg-green-200">+ Add Spouse</button>
          <input type="range" id="spouseCover" min="0" max="50000" step="5000" value="0" class="w-full mt-2" oninput="updateCoverLabel();calculateQuote()" />
          <p class="text-center text-sm">Cover: <span id="spouseCoverLabel">R0</span></p>
        </div>

        <div class="mb-4" id="childrenDiv">
          <h3 class="font-medium mb-2">Children</h3>
          <div id="childList" class="space-y-2 mb-2"></div>
          <button onclick="addMember('child')" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg w-full hover:bg-blue-200">+ Add Child</button>
          <select id="childBenefit" class="w-full p-2 rounded-lg border mt-2" onchange="calculateQuote()">
            <option value="0">No Children Benefit</option>
            <option value="KV5">KV5 (R10k max)</option>
            <option value="KV6">KV6 (R15k max)</option>
            <option value="KV7">KV7 (R30k max)</option>
            <option value="KV8">KV8 - Repatriation</option>
          </select>
        </div>

        <div class="mb-4">
          <h3 class="font-medium mb-2">Parents</h3>
          <div id="parentList" class="space-y-2 mb-2"></div>
          <button onclick="addMember('parent')" class="bg-purple-100 text-purple-700 px-4 py-2 rounded-lg w-full hover:bg-purple-200">+ Add Parent</button>
          <input type="range" id="parentCover" min="0" max="30000" step="5000" value="0" class="w-full mt-2" oninput="updateCoverLabel();calculateQuote()" />
          <p class="text-center text-sm">Cover: <span id="parentCoverLabel">R0</span></p>
        </div>

        <div>
          <h3 class="font-medium mb-2">Extended Family</h3>
          <div id="extendedList" class="space-y-2 mb-2"></div>
          <button onclick="addMember('extended')" class="bg-orange-100 text-orange-700 px-4 py-2 rounded-lg w-full hover:bg-orange-200">+ Add Extended Family</button>
          <input type="range" id="extendedCover" min="0" max="30000" step="5000" value="0" class="w-full mt-2" oninput="updateCoverLabel();calculateQuote()" />
          <p class="text-center text-sm">Cover: <span id="extendedCoverLabel">R0</span></p>
        </div>
      </section>

      <!-- Results -->
      <section id="results" class="bg-white p-5 rounded-2xl shadow-md hidden">
        <h2 class="font-semibold text-lg mb-3">Your Quote</h2>
        <div id="resultsContainer" class="space-y-3"></div>

        <div class="mt-6 p-4 bg-green-50 rounded-lg">
          <h3 class="font-semibold mb-2">Ready to apply?</h3>
          <p class="text-sm text-gray-700 mb-3">Send your details via WhatsApp and I'll process your application</p>
          <button id="whatsappBtn" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700">
            Send via WhatsApp
          </button>
        </div>
      </section>
    </main>
  </div>

<!-- Fixed Top Bar -->
<div id="fixedBottomBar" 
     class="fixed top-0 left-0 right-0 bg-white border-b shadow-lg p-3 flex justify-between items-center z-50">

  <button id="viewPremiumBtn" 
          onclick="scrollToPremium()"
          class="flex-1 bg-green-600 text-white py-3 mr-2 rounded-xl font-semibold text-center">
    View Premium
  </button>

  <button id="whatsappFixedBtn"
          class="flex-1 bg-green-700 text-white py-3 ml-2 rounded-xl font-semibold text-center">
    WhatsApp Me
  </button>

</div>

  <script>
        function setRepatriationCover(amount) {
      document.getElementById('mainCoverHidden').value = amount;
      document.getElementById('mainCoverLabelRepat').textContent = 'R' + amount.toLocaleString();
      calculateQuote();
      updateRepatriationButtons();
    }

    function updateRepatriationButtons() {
      const value = Number(document.getElementById('mainCoverHidden').value);
      document.querySelectorAll('#repatriationCoverControls button').forEach(btn => {
        if (parseInt(btn.textContent.match(/\d+/)[0]) * 1000 === value) {
          btn.classList.remove('bg-white', 'border-gray-300');
          btn.classList.add('bg-green-600', 'text-white', 'border-green-600');
        } else {
          btn.classList.remove('bg-green-600', 'text-white', 'border-green-600');
          btn.classList.add('bg-white', 'border-gray-300');
        }
      });
    }
    // Premium rate tables from the manuals (kept same as your source)
    const premiumRates = {
      cashback: {
        J18: {
          '18-24': [36,45,49.05,57.23,62,69.75,77.5,85.25,93,100.75,108.5,116.25,124,131.75,139.5,147.25,155],
          '25-39': [47,58.75,64.95,75.78,82,92.25,102.5,112.75,123,133.25,143.5,153.75,164,174.25,184.5,194.75,205],
          '40-44': [52,65,73.05,85.23,93,104.63,116.25,127.88,139.5,151.13,162.75,174.38,186,197.63,209.25,220.88,232.5],
          '45-49': [57,71.25,79.95,93.28,102,114.75,127.5,140.25,153,165.75,178.5,191.25,204,216.75,229.5,242.25,255],
          '50-54': [64,80,90,105,116,130.5,145,159.5,174,188.5,203,217.5,232,246.5,261,275.5,290],
          '55-59': [74,92.5,106.05,123.73,138,155.25,172.5,189.75,207,224.25,241.5,258.75,276,293.25,310.5,327.75,345],
          '60-64': [90,112.5,130.05,151.73,170,191.25,212.5,233.75,255,276.25,297.5,318.75,340,361.25,382.5,403.75,425]
        },
        J19: {
          '18-24': [56,70,78,91,99,111.38,123.75,136.13,148.5,160.88,173.25,185.63,198,210.38,222.75,235.13,247.5],
          '25-39': [75,93.75,106.05,123.73,137,154.13,171.25,188.38,205.5,222.63,239.75,256.88,274,291.13,308.25,325.38,342.5],
          '40-44': [83,103.75,118.05,137.73,153,172.13,191.25,210.38,229.5,248.63,267.75,286.88,306,325.13,344.25,363.38,382.5],
          '45-49': [91,113.75,130.05,151.73,168,189,210,231,252,273,294,315,336,357,378,399,420],
          '50-54': [101,126.25,145.95,170.28,190,213.75,237.5,261.25,285,308.75,332.5,356.25,380,403.75,427.5,451.25,475],
          '55-59': [119,148.75,172.05,200.73,225,253.13,281.25,309.38,337.5,365.63,393.75,421.88,450,478.13,506.25,534.38,562.5],
          '60-64': [144,180,210,245,276,310.5,345,379.5,414,448.5,483,517.5,552,586.5,621,655.5,690]
        },
        spouse: {
          '18-24': [30,37.5,36,42,42,47.25,52.5,57.75,63,68.25,73.5,78.75,84,89.25,94.5,99.75,105],
          '25-39': [38,47.5,48,56,58,65.25,72.5,79.75,87,94.25,101.5,108.75,116,123.25,130.5,137.75,145],
          '40-44': [42,52.5,54,63,66,74.25,82.5,90.75,99,107.25,115.5,123.75,132,140.25,148.5,156.75,165],
          '45-49': [46,57.5,58.95,68.78,73,82.13,91.25,100.38,109.5,118.63,127.75,136.88,146,155.13,164.25,173.38,182.5],
          '50-54': [51,63.75,67.95,79.28,85,95.63,106.25,116.88,127.5,138.13,148.75,159.38,170,180.63,191.25,201.88,212.5],
          '55-59': [61,76.25,82.05,95.73,104,117,130,143,156,169,182,195,208,221,234,247,260],
          '60-64': [74,92.5,103.05,120.23,131,147.38,163.75,180.13,196.5,212.88,229.25,245.63,262,278.38,294.75,311.13,327.5]
        },
        parent: {
          'to44': [52,65,73.05,85.23,93,104.63,116.25,127.88,139.5],
          '45-49': [57,71.25,79.95,93.28,102,114.75,127.5,140.25,153],
          '50-54': [64,80,90,105,116,130.5,145,159.5,174],
          '55-59': [74,92.5,106.05,123.73,138,155.25,172.5,189.75,207],
          '60-64': [90,112.5,130.05,151.73,170,191.25,212.5,233.75,255],
          '65-69': [120,150,178.2,207.9,234.6,263.93,293.25,322.58,351.9],
          '70-74': [159.5,199.38,241.05,281.23,320.4,360.45,400.5,440.55,480.6],
          '75-79': [212.7,265.88,325.8,380.1,436.2,490.73,545.25,599.78,654.3]
        },
        extended: {
          'to24': [29,36.25,43.5,50.75,58,65.25,72.5,79.75,87],
          '25-39': [38,47.5,57,66.5,76,85.5,95,104.5,114],
          '40-44': [43,53.75,64.5,75.25,86,96.75,107.5,118.25,129],
          '45-49': [47,58.75,70.5,82.25,94,105.75,117.5,129.25,141],
          '50-54': [54,67.5,81,94.5,108,121.5,135,148.5,162],
          '55-59': [65,81.25,97.5,113.75,130,146.25,162.5,178.75,195],
          '60-64': [77,96.25,115.5,134.75,154,173.25,192.5,211.75,231],
          '65-69': [94,117.5,141,164.5,188,211.5,235,258.5,282],
          '70-74': [125,156.25,187.5,218.75,250,281.25,312.5,343.75,375]
        },
        children: {
          KV5: 21,
          KV6: 37,
          KV7: 67
        }
      },
      repatriation: {
        R11: {
          '18-24': [41,65,93],
          '25-39': [51,83,120],
          '40-44': [56,93,135],
          '45-49': [60,101,147],
          '50-54': [67,113,166],
          '55-59': [76,133,195],
          '60-64': [90,162,239]
        },
        R12: {
          '18-24': [59,98,143],
          '25-39': [77,132,194],
          '40-44': [84,147,216],
          '45-49': [91,160,236],
          '50-54': [100,180,266],
          '55-59': [116,212,313],
          '60-64': [139,257,382]
        },
        spouse: {
          '18-24': [27,38,57],
          '25-39': [34,52,78],
          '40-44': [38,59,89],
          '45-49': [41,66,99],
          '50-54': [46,77,115],
          '55-59': [55,94,140],
          '60-64': [67,118,177]
        },
        parent: {
          'to44': [47,84,126],
          '45-49': [51,92,138],
          '50-54': [58,104,157],
          '55-59': [67,124,186],
          '60-64': [81,153,230],
          '65-69': [108,211,317],
          '70-74': [144,288,433],
          '75-79': [191,393,589.5]
        },
        extended: {
          'to24': [26,52,78],
          '25-39': [34,68,103],
          '40-44': [39,77,116],
          '45-49': [42,85,127],
          '50-54': [49,97,146],
          '55-59': [59,117,176],
          '60-64': [69,139,208],
          '65-69': [85,169,254],
          '70-74': [113,225,338]
        },
        children: {
          KV8: [31,57,85]
        }
      },
      pensioner: {
        '65-74': 150,
        '75-79': 180,
        '80-84': 220,
        single: 10000
      }
    };
    
    /* -------------------- Date helpers & age functions -------------------- */
    function safeDate(dobStr) {
      if (!dobStr) return null;
      // Expect "YYYY-MM-DD" from <input type="date">
      const parts = String(dobStr).split('-').map(Number);
      if (parts.length !== 3) return null;
      const [year, month, day] = parts;
      const d = new Date(year, month - 1, day);
      return isNaN(d) ? null : d;
    }

    function calculateAge(dob) {
      if (!dob) return null;
      const birthDate = safeDate(dob);
      if (!birthDate) return null;
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
      return age;
    }

    function ageLastBirthday(dobStr){
      if (!dobStr) return null;
      const dob = safeDate(dobStr);
      if (!dob) return null;
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      if (today.getMonth() < dob.getMonth() || (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) age--;
      return age;
    }

    /* -------------------- Age band (for main member) -------------------- */
    function getAgeBand(age, product) {
      if (age === null || isNaN(age)) return null;
      if (product === 'pensioner') {
        if (age >= 65 && age <= 74) return '65-74';
        if (age >= 75 && age <= 79) return '75-79';
        if (age >= 80 && age <= 84) return '80-84';
        if (age >= 85) return '85+';
        return null;
      }
      // Cashback & Repatriation main member bands
      if (age < 18) return null;
      if (age >= 18 && age <= 24) return '18-24';
      if (age >= 25 && age <= 39) return '25-39';
      if (age >= 40 && age <= 44) return '40-44';
      if (age >= 45 && age <= 49) return '45-49';
      if (age >= 50 && age <= 54) return '50-54';
      if (age >= 55 && age <= 59) return '55-59';
      if (age >= 60 && age <= 64) return '60-64';
      if (age >= 65 && age <= 69) return '65-69';
      if (age >= 70 && age <= 74) return '70-74';
      if (age >= 75 && age <= 79) return '75-79';
      return null;
    }

    function getCoverIndex(cover) {
      const amounts = [10000,12500,15000,17500,20000,22500,25000,27500,30000,32500,35000,37500,40000,42500,45000,47500,50000];
      return amounts.indexOf(Number(cover));
    }

    /* -------------------- UI helpers -------------------- */
    function updateProductFields() {
      const product = document.getElementById('productType').value;
      const mainSection = document.getElementById('mainSection');
      const additionalSection = document.getElementById('additionalSection');
      const pensionerOptions = document.getElementById('pensionerOptions');
      const payerTypeDiv = document.getElementById('payerTypeDiv');
      const childrenDiv = document.getElementById('childrenDiv');

      if (product) {
        mainSection.classList.remove('hidden');

        if (product === 'pensioner') {
          // Pensioner: hide additional members and payer type
          pensionerOptions.classList.remove('hidden');
          payerTypeDiv.classList.add('hidden');
          additionalSection.classList.add('hidden');
        } else {
          // Cashback or Repatriation
          pensionerOptions.classList.add('hidden');
          payerTypeDiv.classList.remove('hidden');
          additionalSection.classList.remove('hidden');

          // === YOUR REQUESTED UPDATE ===
          if (product === 'repatriation') {
            const cashbackControls = document.getElementById('cashbackCoverControls');
            const repatriationControls = document.getElementById('repatriationCoverControls');

            // Reuse the existing main slider for repatriation: move it into repatriation container
            const mainCover = document.getElementById('mainCover');
            const mainCoverLabel = document.getElementById('mainCoverLabel');
            // Clear repatriation container and append slider + label there
            if (repatriationControls && mainCover && mainCoverLabel) {
              repatriationControls.innerHTML = '';
              mainCover.min = 10000;
              mainCover.max = 30000;
              mainCover.step = 10000;
              mainCover.value = 20000;
              mainCover.oninput = function() { updateCoverLabel(); calculateQuote(); };
              repatriationControls.appendChild(mainCover);
              repatriationControls.appendChild(mainCoverLabel);
              mainCoverLabel.textContent = 'R' + Number(mainCover.value).toLocaleString();
            }

            cashbackControls.classList.add('hidden');
            repatriationControls.classList.remove('hidden');

            // Repatriation children benefit options
            childrenDiv.querySelector('select').innerHTML = `
              <option value="0">No Children Benefit</option>
              <option value="KV8">KV8 - Repatriation</option>
            `;
          } else {
            // Cashback: ensure the main slider is back in the cashback container with full range
            const cashbackControls = document.getElementById('cashbackCoverControls');
            const repatriationControls = document.getElementById('repatriationCoverControls');
            const mainCover = document.getElementById('mainCover');
            const mainCoverLabel = document.getElementById('mainCoverLabel');
            if (cashbackControls && mainCover && mainCoverLabel) {
              cashbackControls.innerHTML = '';
              mainCover.min = 10000;
              mainCover.max = 50000;
              mainCover.step = 5000;
              mainCover.value = 20000;
              mainCover.oninput = function() { updateCoverLabel(); calculateQuote(); };
              cashbackControls.appendChild(mainCover);
              cashbackControls.appendChild(mainCoverLabel);
              mainCoverLabel.textContent = 'R' + Number(mainCover.value).toLocaleString();
            }
            cashbackControls.classList.remove('hidden');
            repatriationControls.classList.add('hidden');

            // Cashback children benefit options
            childrenDiv.querySelector('select').innerHTML = `
              <option value="0">No Children Benefit</option>
              <option value="KV5">KV5 (R10k max)</option>
              <option value="KV6">KV6 (R15k max)</option>
              <option value="KV7">KV7 (R30k max)</option>
            `;
          }
          // === END OF YOUR REQUESTED UPDATE ===
        }
      } else {
        // No product selected
        mainSection.classList.add('hidden');
        additionalSection.classList.add('hidden');
      }

      updateCoverLabel();
      calculateQuote(); // Refresh quote when switching products
    }

    function updateCoverLabel() {
      ['main','spouse','parent','extended'].forEach(type => {
        const slider = document.getElementById(type + 'Cover');
        const label = document.getElementById(type + 'CoverLabel');
        if (slider && label) label.textContent = 'R' + Number(slider.value).toLocaleString();
      });
    }

    function addMember(type) {
      const list = document.getElementById(type + 'List');
      const div = document.createElement('div');
      div.className = 'p-3 bg-slate-50 rounded-lg';
      div.innerHTML = `
        <input type="text" placeholder="Full name" class="w-full p-2 rounded-lg border mb-2 name" />
        <input type="date" class="w-full p-2 rounded-lg border dob" onchange="calculateQuote()" />
        <button type="button" class="mt-2 text-red-600 text-sm removeBtn">Remove</button>
      `;
      list.appendChild(div);

      // attach remove handler and recalc
      div.querySelector('.removeBtn').addEventListener('click', function() {
        div.remove();
        calculateQuote();
      });

      calculateQuote();
    }

    /* -------------------- Main calculation -------------------- */
    function calculateQuote(){
      const product = document.getElementById('productType').value;
      if (!product) {
        document.getElementById('results').classList.add('hidden');
        return;
      }
      function getRepatriationTier(cover) {
        const map = { 10000: 0, 20000: 1, 30000: 2 };
        return map[cover] ?? null;
      }
      const mainName = document.getElementById('mainName').value || 'Main Member';
      const mainDOB = document.getElementById('mainDOB').value;
      const mainAge = calculateAge(mainDOB);

      // require a valid main age for non-pensioner products; for pensioner we also need mainAge
      if (mainAge === null || isNaN(mainAge)) {
        document.getElementById('results').classList.add('hidden');
        return;
      }

      const resultsContainer = document.getElementById('resultsContainer');
      resultsContainer.innerHTML = '';

      let totalPremium = 0;
      let quoteDetails = [];

      if (product === 'pensioner') {
        const premType = document.getElementById('pensionerPremType').value;
        const ageBand = getAgeBand(mainAge, 'pensioner');
        if (!ageBand) {
          document.getElementById('results').classList.add('hidden');
          return;
        }
        let premium = premType === 'single' ? premiumRates.pensioner.single : premiumRates.pensioner[ageBand];
        let coverAmount = premType === 'single' ? 10000 : 8000;
        totalPremium = premium;
        quoteDetails.push({
          name: mainName,
          type: 'Main Member',
          age: mainAge,
          cover: coverAmount,
          premium: premium,
          frequency: premType === 'single' ? 'once-off' : 'monthly'
        });
      } else {
        // cashback or repatriation
        const payerType = document.getElementById('payerType').value;
        const tableCode = product === 'cashback' ? (payerType === 'self' ? 'J18' : 'J19') : (payerType === 'self' ? 'R11' : 'R12');
        const mainCover = Number(document.getElementById('mainCover').value);
        const ageBand = getAgeBand(mainAge, product);

        if (!ageBand) {
          // if age out of range for main member, hide results
          document.getElementById('results').classList.add('hidden');
          return;
        }

        const coverIndex = getCoverIndex(mainCover);
        if (coverIndex >= 0) {
          const rateTable = product === 'cashback' ? premiumRates.cashback[tableCode] : premiumRates.repatriation[tableCode];
          if (rateTable && rateTable[ageBand] && typeof rateTable[ageBand][coverIndex] !== 'undefined') {
            const premium = rateTable[ageBand][coverIndex];
            totalPremium += premium;
            quoteDetails.push({
              name: mainName,
              type: 'Main Member (' + tableCode + ')',
              age: mainAge,
              cover: mainCover,
              premium: premium,
              frequency: 'monthly'
            });
          } else {
            // missing rate lookup => hide and exit
            console.warn('Rate not found for main member:', product, tableCode, ageBand, coverIndex);
            document.getElementById('results').classList.add('hidden');
            return;
          }
        } else {
          // invalid cover value
          document.getElementById('results').classList.add('hidden');
          return;
        }

        // --- Spouse --- //
        const spouseCover = Number(document.getElementById('spouseCover').value);
        if (spouseCover > 0) {
          document.querySelectorAll('#spouseList > div').forEach(div => {
            const spouseName = div.querySelector('.name').value || 'Spouse';
            const spouseDOB = div.querySelector('.dob').value;
            const spouseAge = calculateAge(spouseDOB);
            if (spouseAge === null) return;

            // spouse age band for spouse tables (same band names as main)
            let spouseAgeBand = getAgeBand(spouseAge, product);
            if (!spouseAgeBand) return;

            let premium;
            if (product === 'cashback') {
              const coverIndexSp = getCoverIndex(spouseCover);
              if (coverIndexSp === -1) return;
              const rate = premiumRates.cashback.spouse[spouseAgeBand];
              if (!rate || typeof rate[coverIndexSp] === 'undefined') return;
              premium = rate[coverIndexSp];
            } else {
              // repatriation: spouse tiers are 10k/20k/30k only
              const tierMap = {10000:0,20000:1,30000:2};
              const tier = tierMap[spouseCover];
              if (tier === undefined) return;
              const rate = premiumRates.repatriation.spouse[spouseAgeBand];
              if (!rate || typeof rate[tier] === 'undefined') return;
              premium = rate[tier];
            }

            totalPremium += premium;
            quoteDetails.push({
              name: spouseName,
              type: 'Spouse (' + (product === 'cashback' ? 'CO1' : 'CO2') + ')',
              age: spouseAge,
              cover: spouseCover,
              premium: premium,
              frequency: 'monthly'
            });
          });
        }

        // --- Children --- //
        const childBenefit = document.getElementById('childBenefit').value;
        const childCount = document.querySelectorAll('#childList > div').length;
        if (childBenefit !== '0' && childCount > 0) {
          let childPremiumPer = 0;
          if (product === 'cashback') {
            childPremiumPer = premiumRates.cashback.children[childBenefit] || 0;
            // premiumRates.cashback.children are flat per child per selection
            if (!childPremiumPer) {
              console.warn('No cashback child rate for', childBenefit);
            }
          } else { // repatriation KV8 has array tiers? here it's stored in repatriation.children
            if (childBenefit === 'KV8') {
              // we will use first tier (10k) as default; repatriation.children.KV8 is array of three tiers [31,57,85]
              // However your UI doesn't collect per-child cover tier; we'll treat KV8 as single per-child default (10k)
              const kv8 = premiumRates.repatriation.children.KV8;
              childPremiumPer = Array.isArray(kv8) ? kv8[0] : 0; // choose 10k tier
            }
          }

          if (childPremiumPer > 0) {
            const totalChildPremium = childPremiumPer * childCount;
            totalPremium += totalChildPremium;
            quoteDetails.push({
              name: childCount + ' Child(ren)',
              type: 'Children (' + childBenefit + ')',
              age: '-',
              cover: childBenefit === 'KV5' ? 10000 : (childBenefit === 'KV6' ? 15000 : (childBenefit === 'KV7' ? 30000 : 10000)),
              premium: totalChildPremium,
              frequency: 'monthly'
            });
          }
        }

        // --- Parents --- //
        const parentCover = Number(document.getElementById('parentCover').value);
        if (parentCover > 0) {
          document.querySelectorAll('#parentList > div').forEach(div => {
            const parentName = div.querySelector('.name').value || 'Parent';
            const parentDOB = div.querySelector('.dob').value;
            const parentAge = calculateAge(parentDOB);
            if (parentAge === null) return;

            // parent band mapping: parents table uses 'to44' for <=44
            let parentAgeBand = null;
            if (parentAge <= 44) parentAgeBand = 'to44';
            else if (parentAge >=45 && parentAge <=49) parentAgeBand = '45-49';
            else if (parentAge >=50 && parentAge <=54) parentAgeBand = '50-54';
            else if (parentAge >=55 && parentAge <=59) parentAgeBand = '55-59';
            else if (parentAge >=60 && parentAge <=64) parentAgeBand = '60-64';
            else if (parentAge >=65 && parentAge <=69) parentAgeBand = '65-69';
            else if (parentAge >=70 && parentAge <=74) parentAgeBand = '70-74';
            else if (parentAge >=75 && parentAge <=79) parentAgeBand = '75-79';

            const parentCoverIndex = getCoverIndex(parentCover);
            const parentRateTable = product === 'cashback' ? premiumRates.cashback.parent : premiumRates.repatriation.parent;
            if (parentAgeBand && parentCoverIndex >= 0 && parentRateTable && parentRateTable[parentAgeBand] && typeof parentRateTable[parentAgeBand][parentCoverIndex] !== 'undefined') {
              const premium = parentRateTable[parentAgeBand][parentCoverIndex];
              totalPremium += premium;
              quoteDetails.push({
                name: parentName,
                type: 'Parent (OV' + (product === 'cashback' ? '6' : '8') + ')',
                age: parentAge,
                cover: parentCover,
                premium: premium,
                frequency: 'monthly'
              });
            }
          });
        }

        // --- Extended family --- //
        const extendedCover = Number(document.getElementById('extendedCover').value);
        if (extendedCover > 0) {
          document.querySelectorAll('#extendedList > div').forEach(div => {
            const extName = div.querySelector('.name').value || 'Extended Family';
            const extDOB = div.querySelector('.dob').value;
            const extAge = calculateAge(extDOB);
            if (extAge === null) return;

            // extended uses 'to24' for <=24
            let extAgeBand = null;
            if (extAge <= 24) extAgeBand = 'to24';
            else if (extAge >=25 && extAge <=39) extAgeBand = '25-39';
            else if (extAge >=40 && extAge <=44) extAgeBand = '40-44';
            else if (extAge >=45 && extAge <=49) extAgeBand = '45-49';
            else if (extAge >=50 && extAge <=54) extAgeBand = '50-54';
            else if (extAge >=55 && extAge <=59) extAgeBand = '55-59';
            else if (extAge >=60 && extAge <=64) extAgeBand = '60-64';
            else if (extAge >=65 && extAge <=69) extAgeBand = '65-69';
            else if (extAge >=70 && extAge <=74) extAgeBand = '70-74';

            const extCoverIndex = getCoverIndex(extendedCover);
            const extRateTable = product === 'cashback' ? premiumRates.cashback.extended : premiumRates.repatriation.extended;
            if (extAgeBand && extCoverIndex >= 0 && extRateTable && extRateTable[extAgeBand] && typeof extRateTable[extAgeBand][extCoverIndex] !== 'undefined') {
              const premium = extRateTable[extAgeBand][extCoverIndex];
              totalPremium += premium;
              quoteDetails.push({
                name: extName,
                type: 'Extended (EX' + (product === 'cashback' ? '6' : '8') + ')',
                age: extAge,
                cover: extendedCover,
                premium: premium,
                frequency: 'monthly'
              });
            }
          });
        }
      }

      // Show results if we have details
      if (quoteDetails.length > 0) {
        // Policy fee for cashback
        if (document.getElementById('productType').value === 'cashback') {
          totalPremium += 10;
          quoteDetails.push({ name: 'Policy Fee', type:'Fee', age:'', cover: '', premium: 10, frequency: 'monthly' });
        }

        // Render individual cards (except fee we render later)
        resultsContainer.innerHTML = '';
        quoteDetails.forEach(detail => {
          const card = document.createElement('div');
          card.className = 'p-4 bg-gradient-to-r from-green-50 to-white rounded-lg border-l-4 border-green-600';
          card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <div>
                <h3 class="font-semibold text-gray-800">${detail.name}</h3>
                <p class="text-sm text-gray-600">${detail.type}${ detail.age ? ' • Age: ' + detail.age : '' }</p>
              </div>
              <div class="text-right">
                <p class="text-2xl font-bold text-green-700">R${detail.premium.toLocaleString()}</p>
                <p class="text-xs text-gray-500">${detail.frequency}</p>
              </div>
            </div>
            <p class="text-sm text-gray-700">Cover Amount: <span class="font-semibold">${detail.cover ? 'R' + detail.cover.toLocaleString() : '-'}</span></p>
          `;
          resultsContainer.appendChild(card);
        });

        // Total card
        const totalCard = document.createElement('div');
        totalCard.className = 'p-4 bg-green-700 text-white rounded-lg mt-4';
        totalCard.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="text-lg font-semibold">TOTAL MONTHLY PREMIUM</span>
            <span class="text-3xl font-bold">R${totalPremium.toLocaleString()}</span>
          </div>
        `;
        resultsContainer.appendChild(totalCard);

        // Update fixed bottom bar with live total
        updateStickyTotal(totalPremium);

        // WhatsApp message
        let waMessage = `AVBOB Quote Request%0A%0A`;
        const product = document.getElementById('productType').value;
        waMessage += `Product: ${product === 'cashback' ? 'Cashback Funeral Cover' : (product === 'repatriation' ? 'Cash Policy (Repatriation)' : 'Pensioner Funeral Plan')}%0A`;
        waMessage += `Total Premium: R${totalPremium}%0A%0AMembers:%0A`;
        quoteDetails.forEach(detail => {
          waMessage += `• ${detail.name} (${detail.type})%0A  Cover: ${detail.cover ? 'R' + detail.cover : '-'}, Premium: R${detail.premium}%0A`;
        });
        waMessage += `%0APlease contact me to complete the application.%0A%0ADocuments needed:%0A• ID copies of all members%0A• Bank details for debit order%0A• Proof of income/salary slip`;

        document.getElementById('whatsappBtn').onclick = function() {
          window.open(`https://wa.me/27678441434?text=${waMessage}`, '_blank');
        };

        document.getElementById('results').classList.remove('hidden');
      } else {
        // clear sticky total when no quote
        updateStickyTotal(null);
        document.getElementById('results').classList.add('hidden');
      }
    }

    // Initial UI setup
    updateCoverLabel();
    // expose calculateQuote to input handlers (already used inline)
    window.calculateQuote = calculateQuote;
    window.updateProductFields = updateProductFields;
    window.addMember = addMember;
    
    // Scroll to results helper used by fixed top bar
    function scrollToPremium() {
      const results = document.getElementById('results');
      const bar = document.getElementById('fixedBottomBar');
      if (!results.classList.contains('hidden')) {
        const barHeight = bar ? bar.offsetHeight : 0;
        const top = results.getBoundingClientRect().top + window.pageYOffset - barHeight - 12;
        window.scrollTo({ top, behavior: 'smooth' });
      } else {
        alert('Please complete member details to view premiums.');
      }
    }

    // Wire bottom-bar WhatsApp button to the existing WhatsApp generator
    const whatsappFixed = document.getElementById('whatsappFixedBtn');
    if (whatsappFixed) {
      whatsappFixed.onclick = function() {
        const inner = document.getElementById('whatsappBtn');
        if (inner) inner.click();
        else alert('Please generate a quote first.');
      };
    }

    // Update the fixed bottom bar button with the live total premium
    function updateStickyTotal(amount) {
      const btn = document.getElementById('viewPremiumBtn');
      if (!btn) return;
      if (typeof amount === 'number' && !isNaN(amount) && amount > 0) {
        btn.textContent = `View Premium • R${amount.toLocaleString()}`;
      } else {
        btn.textContent = 'View Premium';
      }
    }
  </script>
</body>
</html>
